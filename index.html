<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Acreditación Metrológica - Caudal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f8fafc;
            color: #334155;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .header-title {
            font-size: 28px;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-subtitle {
            color: #64748b;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-purple { background: #8b5cf6; color: white; }

        .btn:hover { transform: translateY(-1px); opacity: 0.9; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .stats-section {
            background: white;
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 24px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stats-title {
            font-size: 24px;
            color: #3b82f6;
            margin-bottom: 24px;
        }

        .progress-circle {
            width: 150px;
            height: 150px;
            margin: 0 auto 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .progress-inner {
            width: 120px;
            height: 120px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .progress-number {
            font-size: 36px;
            font-weight: bold;
            color: #3b82f6;
        }

        .progress-total {
            font-size: 14px;
            color: #64748b;
        }

        .search-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
        }

        .search-input:focus {
            border-color: #3b82f6;
        }

        .annexes-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .section-title {
            font-size: 20px;
            color: #3b82f6;
            margin-bottom: 24px;
            font-weight: 600;
        }

        .annex-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 12px;
            transition: all 0.2s;
            background: #fafafa;
        }

        .annex-item:hover {
            border-color: #cbd5e1;
        }

        .annex-item.editing {
            background: #fef3c7;
            border-color: #f59e0b;
        }

        .annex-left {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
        }

        .annex-icon {
            font-size: 24px;
            width: 40px;
            text-align: center;
        }

        .annex-info {
            flex: 1;
        }

        .annex-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .annex-date {
            font-size: 12px;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .annex-comment {
            font-size: 14px;
            color: #64748b;
            margin-top: 8px;
            font-style: italic;
        }

        .annex-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: white;
            text-align: center;
            min-width: 80px;
        }

        .status-iniciando { background: #ef4444; }
        .status-progreso { background: #f59e0b; }
        .status-avanzado { background: #3b82f6; }
        .status-completado { background: #10b981; }

        .progress-display {
            text-align: center;
            margin: 0 12px;
        }

        .progress-fraction {
            font-size: 18px;
            font-weight: bold;
            color: #1e293b;
        }

        .progress-percentage {
            font-size: 12px;
            color: #64748b;
        }

        .progress-bar-container {
            width: 100px;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin: 4px 0;
        }

        .progress-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .edit-btn {
            background: #f1f5f9;
            border: none;
            border-radius: 6px;
            padding: 8px;
            cursor: pointer;
            font-size: 16px;
            color: #3b82f6;
            transition: all 0.2s;
        }

        .edit-btn:hover {
            background: #e2e8f0;
            transform: scale(1.1);
        }

        .edit-form {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            margin-top: 12px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .edit-select {
            padding: 8px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 14px;
        }

        .edit-textarea {
            flex: 1;
            padding: 8px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
        }

        .edit-controls {
            display: flex;
            gap: 8px;
            flex-direction: column;
        }

        .icon-btn {
            padding: 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }

        .save-btn {
            background: #dcfce7;
            color: #166534;
        }

        .cancel-btn {
            background: #fee2e2;
            color: #dc2626;
        }

        .save-btn:hover { background: #bbf7d0; }
        .cancel-btn:hover { background: #fecaca; }

        .saved-indicator {
            color: #10b981;
            font-size: 14px;
            margin-top: 8px;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .container { padding: 12px; }
            .annex-item { flex-direction: column; align-items: stretch; }
            .annex-right { justify-content: space-between; margin-top: 12px; }
            .edit-form { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1 class="header-title">
                <span>💧</span>
                Acreditación Metrológica - Caudal
            </h1>
            <p class="header-subtitle">Sistema de medición de caudal de fluidos</p>
            <div id="saved-indicator" class="saved-indicator hidden"></div>
            
            <div class="controls">
                <button class="btn btn-purple" onclick="generateReport()" id="report-btn">
                    Generar Reporte
                </button>
                <button class="btn btn-primary" onclick="exportData()">
                    Exportar
                </button>
                <label class="btn btn-success" style="cursor: pointer;">
                    Importar
                    <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
                </label>
                <button class="btn btn-danger" onclick="resetData()">
                    Reset
                </button>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-section">
            <h2 class="stats-title">💧 Medición de Caudal</h2>
            <div class="progress-circle" id="progress-circle">
                <div class="progress-inner">
                    <div class="progress-number" id="progress-number">1</div>
                    <div class="progress-total">de 10</div>
                </div>
            </div>
            <p style="font-size: 20px; color: #3b82f6; font-weight: bold;" id="progress-text">
                10% Completado
            </p>
        </div>

        <!-- Search -->
        <div class="search-section">
            <input 
                type="text" 
                class="search-input" 
                placeholder="🔍 Buscar anexos..." 
                oninput="filterAnnexes(this.value)"
                id="search-input"
            >
        </div>

        <!-- Annexes -->
        <div class="annexes-section">
            <h3 class="section-title">Anexos de Acreditación</h3>
            <div id="annexes-list">
                <!-- Los anexos se renderizan aquí -->
            </div>
        </div>
    </div>

    <script>
        // Datos de anexos
        const annexes = [
            { id: 11, name: "Procedimiento de calibración", icon: "⚙️" },
            { id: 12, name: "Procedimiento para incertidumbre", icon: "📊" },
            { id: 13, name: "Procedimiento de verificaciones", icon: "✅" },
            { id: 14, name: "Procedimiento para el aseguramiento", icon: "⚠️" },
            { id: 15, name: "Procedimientos para patrones", icon: "⚙️" },
            { id: 16, name: "Procedimientos para los ítems de calibración", icon: "📄" },
            { id: 17, name: "Validación de método", icon: "✅" },
            { id: 18, name: "Presupuesto de la incertidumbre", icon: "📊" },
            { id: 19, name: "Informe de validación de HC", icon: "📄" },
            { id: 20, name: "Condiciones ambientales", icon: "⚙️" },
            { id: 21, name: "Personal", icon: "👥" },
            { id: "22a", name: "Alcance solicitado", icon: "📄" },
            { id: "22b", name: "Declaración de conformidad", icon: "✅" },
            { id: 26, name: "Equipos", icon: "⚙️" },
            { id: 27, name: "Aseguramiento de los resultados", icon: "⚠️" },
            { id: 28, name: "Lista de persona(s) autorizada", icon: "👥" },
            { id: 29, name: "Ejemplo de certificado", icon: "📄" },
            { id: 30, name: "Lista de Interlaboratorios", icon: "👥" }
        ];

        let progressData = {};
        let editingItem = null;
        let searchTerm = '';

        // Inicializar datos
        function initializeData() {
            const saved = localStorage.getItem('caudal-acreditacion');
            if (saved) {
                try {
                    progressData = JSON.parse(saved);
                } catch (error) {
                    console.error('Error loading data:', error);
                    createInitialData();
                }
            } else {
                createInitialData();
            }
            
            // Asegurar que todos los anexos tengan datos
            annexes.forEach(annex => {
                if (!progressData[annex.id]) {
                    progressData[annex.id] = {
                        progress: 1,
                        comment: '',
                        lastUpdated: new Date().toISOString().split('T')[0]
                    };
                }
            });
        }

        function createInitialData() {
            progressData = {};
            annexes.forEach(annex => {
                progressData[annex.id] = {
                    progress: 1,
                    comment: '',
                    lastUpdated: new Date().toISOString().split('T')[0]
                };
            });
        }

        function saveData() {
            try {
                localStorage.setItem('caudal-acreditacion', JSON.stringify(progressData));
                showSavedIndicator();
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }

        function showSavedIndicator() {
            const indicator = document.getElementById('saved-indicator');
            indicator.textContent = 'Último guardado: ' + new Date().toLocaleString('es-ES');
            indicator.classList.remove('hidden');
        }

        // Funciones utilitarias
        function getProgressColor(progress) {
            if (progress <= 3) return '#ef4444';
            if (progress <= 6) return '#f59e0b';
            if (progress <= 8) return '#3b82f6';
            return '#10b981';
        }

        function getStatusText(progress) {
            if (progress === 10) return 'Completado';
            if (progress >= 7) return 'Avanzado';
            if (progress >= 4) return 'En Progreso';
            return 'Iniciando';
        }

        function getStatusClass(progress) {
            if (progress === 10) return 'status-completado';
            if (progress >= 7) return 'status-avanzado';
            if (progress >= 4) return 'status-progreso';
            return 'status-iniciando';
        }

        function calculateOverallProgress() {
            const total = annexes.reduce((sum, annex) => sum + progressData[annex.id].progress, 0);
            return Math.round(total / annexes.length);
        }

        function updateProgressDisplay() {
            const overallProgress = calculateOverallProgress();
            document.getElementById('progress-number').textContent = overallProgress;
            document.getElementById('progress-text').textContent = `${overallProgress * 10}% Completado`;
            
            // Actualizar círculo de progreso
            const circle = document.getElementById('progress-circle');
            const percentage = overallProgress * 10;
            circle.style.background = `conic-gradient(#3b82f6 ${percentage * 3.6}deg, #e2e8f0 0deg)`;
        }

        function renderAnnexes() {
            const container = document.getElementById('annexes-list');
            const filteredAnnexes = annexes.filter(annex => 
                annex.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                annex.id.toString().includes(searchTerm)
            );

            container.innerHTML = filteredAnnexes.map(annex => {
                const data = progressData[annex.id];
                const isEditing = editingItem === annex.id;
                const progress = data.progress;

                return `
                    <div class="annex-item ${isEditing ? 'editing' : ''}">
                        <div class="annex-left">
                            <span class="annex-icon">${annex.icon}</span>
                            <div class="annex-info">
                                <div class="annex-title">Anexo ${annex.id} - ${annex.name}</div>
                                <div class="annex-date">
                                    📅 Última actualización: ${new Date(data.lastUpdated).toLocaleDateString('es-ES')}
                                </div>
                                ${!isEditing && data.comment ? `<div class="annex-comment">"${data.comment}"</div>` : ''}
                            </div>
                        </div>
                        
                        ${!isEditing ? `
                            <div class="annex-right">
                                <span class="status-badge ${getStatusClass(progress)}">
                                    ${getStatusText(progress)}
                                </span>
                                <div class="progress-display">
                                    <div class="progress-fraction">${progress}/10</div>
                                    <div class="progress-bar-container">
                                        <div class="progress-bar" style="width: ${progress * 10}%; background: ${getProgressColor(progress)};"></div>
                                    </div>
                                    <div class="progress-percentage">${progress * 10}%</div>
                                </div>
                                <button class="edit-btn" onclick="startEditing('${annex.id}')" title="Editar">
                                    ✏️
                                </button>
                            </div>
                        ` : `
                            <div style="width: 100%;">
                                <div class="edit-form">
                                    <select class="edit-select" id="temp-progress-${annex.id}">
                                        ${Array.from({length: 10}, (_, i) => 
                                            `<option value="${i + 1}" ${progress === i + 1 ? 'selected' : ''}>${i + 1}/10</option>`
                                        ).join('')}
                                    </select>
                                    <textarea class="edit-textarea" id="temp-comment-${annex.id}" placeholder="Observaciones...">${data.comment}</textarea>
                                    <div class="edit-controls">
                                        <button class="icon-btn save-btn" onclick="saveEditing('${annex.id}')" title="Guardar">✅</button>
                                        <button class="icon-btn cancel-btn" onclick="cancelEditing()" title="Cancelar">❌</button>
                                    </div>
                                </div>
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        // Funciones de edición
        function startEditing(annexId) {
            if (editingItem !== null) {
                cancelEditing();
            }
            editingItem = annexId;
            renderAnnexes();
        }

        function saveEditing(annexId) {
            const progressElement = document.getElementById(`temp-progress-${annexId}`);
            const commentElement = document.getElementById(`temp-comment-${annexId}`);
            
            if (!progressElement || !commentElement) {
                console.error('No se encontraron los elementos del formulario');
                return;
            }
            
            const progress = parseInt(progressElement.value);
            const comment = commentElement.value.trim();
            
            progressData[annexId] = {
                progress: progress,
                comment: comment,
                lastUpdated: new Date().toISOString().split('T')[0]
            };
            
            editingItem = null;
            saveData();
            updateProgressDisplay();
            renderAnnexes();
            
            showSuccessMessage(`Anexo ${annexId} actualizado correctamente`);
        }

        function cancelEditing() {
            editingItem = null;
            renderAnnexes();
        }

        function showSuccessMessage(message) {
            const indicator = document.getElementById('saved-indicator');
            const originalColor = indicator.style.color;
            indicator.textContent = message;
            indicator.classList.remove('hidden');
            indicator.style.color = '#10b981';
            
            setTimeout(() => {
                indicator.style.color = originalColor;
                showSavedIndicator();
            }, 2000);
        }

        function filterAnnexes(term) {
            searchTerm = term;
            renderAnnexes();
        }

        // Funciones de gestión de datos
        function exportData() {
            const dataStr = JSON.stringify(progressData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `caudal-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showSuccessMessage('Datos exportados correctamente');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        progressData = importedData;
                        saveData();
                        updateProgressDisplay();
                        renderAnnexes();
                        showSuccessMessage('Datos importados exitosamente');
                    } catch (error) {
                        alert('Error al leer el archivo. Verifique que sea un archivo JSON válido.');
                    }
                };
                reader.readAsText(file);
            }
            event.target.value = '';
        }

        function resetData() {
            if (confirm('¿Está seguro de resetear todos los datos?')) {
                createInitialData();
                editingItem = null;
                saveData();
                updateProgressDisplay();
                renderAnnexes();
                showSuccessMessage('Datos reseteados correctamente');
            }
        }

        function generateReport() {
            const btn = document.getElementById('report-btn');
            const originalText = btn.textContent;
            btn.textContent = 'Generando...';
            btn.disabled = true;
            
            setTimeout(() => {
                const overallProgress = calculateOverallProgress();
                const completedAnnexes = annexes.filter(annex => progressData[annex.id].progress === 10);
                const urgentAnnexes = annexes.filter(annex => progressData[annex.id].progress <= 3);
                
                const reportHTML = `
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reporte de Acreditación - Caudal</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { background: linear-gradient(135deg, #3b82f6, #1e40af); color: white; padding: 30px; border-radius: 10px; text-align: center; }
        .header h1 { margin: 0; font-size: 28px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        .stat-value { font-size: 32px; font-weight: bold; color: #3b82f6; }
        .progress-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .progress-table th { background: #3b82f6; color: white; padding: 12px; }
        .progress-table td { padding: 10px; border-bottom: 1px solid #ddd; }
    </style>
</head>
<body>
    <div class="header">
        <h1>💧 REPORTE DE ACREDITACIÓN - CAUDAL</h1>
        <p>Fecha: ${new Date().toLocaleDateString('es-ES')}</p>
    </div>
    
    <div class="stats">
        <div class="stat-card">
            <div class="stat-value">${overallProgress}/10</div>
            <p>Progreso General</p>
        </div>
        <div class="stat-card">
            <div class="stat-value">${completedAnnexes.length}</div>
            <p>Anexos Completados</p>
        </div>
        <div class="stat-card">
            <div class="stat-value">${urgentAnnexes.length}</div>
            <p>Anexos Urgentes</p>
        </div>
    </div>
    
    <h2>Estado de Anexos</h2>
    <table class="progress-table">
        <thead>
            <tr><th>Anexo</th><th>Progreso</th><th>Estado</th><th>Observaciones</th></tr>
        </thead>
        <tbody>
            ${annexes.map(annex => {
                const data = progressData[annex.id];
                return `<tr>
                    <td>${annex.icon} ${annex.id} - ${annex.name}</td>
                    <td>${data.progress * 10}%</td>
                    <td>${getStatusText(data.progress)}</td>
                    <td>${data.comment || 'Sin comentarios'}</td>
                </tr>`;
            }).join('')}
        </tbody>
    </table>
</body>
</html>`;
                
                const reportWindow = window.open('', '_blank');
                if (reportWindow) {
                    reportWindow.document.write(reportHTML);
                    reportWindow.document.close();
                    showSuccessMessage('Reporte generado correctamente');
                } else {
                    alert('No se pudo abrir la ventana del reporte.');
                }
                
                btn.textContent = originalText;
                btn.disabled = false;
            }, 1000);
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
            updateProgressDisplay();
            renderAnnexes();
            showSuccessMessage('Sistema cargado correctamente');
        });

        // Atajos de teclado
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && editingItem !== null) {
                cancelEditing();
            }
        });
    </script>
</body>
</html>
